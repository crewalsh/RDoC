---
title: "ISC"
author: "Catherine Walsh"
date: "5/27/2020"
output:
  html_document:
    toc: true 
    toc_float: true 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The first part of this analysis looks at the temporal intersubject correlation - how well the subjects data align over time. Looking at this will allow us to get a measure of "typciality" - how typical an individual subject's brain data is. 

One big caveat here (for both these analyses) is that they're currently done using the SMOOTHED data. 

```{r import libraries, load data}
library(tidyverse)
library(psych)
library(patchwork)
library(reshape2)
library(reticulate)
library(rmatio)
library(rstatix)
reticulate::use_python("/Users/catherinewalsh/miniconda3/bin/python")

load('data/behav.RData')
load('data/split_groups_info.RData')
load('data/ISC_data.RData')

se <- function(x) {
  sd(x,na.rm=TRUE)/sqrt(length(x[!is.na(x)])) 
}

source("helper_fxns/avg_ISC.R")
source("helper_fxns/corr_ISC.R")

rects <- data.frame(xstart=c(7),xend=c(9))

```

```{python load in numpy data,include=FALSE}

import numpy 
high_correct_pairwise = numpy.load('/Users/catherinewalsh/Documents/Code/RDoC_for_GitHub/data/ISC/ISC_pairwise_high_correct.npy')
low_correct_pairwise = numpy.load('/Users/catherinewalsh/Documents/Code/RDoC_for_GitHub/data/ISC/ISC_pairwise_low_correct.npy')
high_correct_spatial_DFR = numpy.load('/Users/catherinewalsh/Documents/Code/RDoC_for_GitHub/data/ISC/sISC_pairwise_high_correct_DFR.npy')
low_correct_spatial_DFR = numpy.load('/Users/catherinewalsh/Documents/Code/RDoC_for_GitHub/data/ISC/sISC_pairwise_low_correct_DFR.npy')

high_correct_spatial_fusiform = numpy.load('/Users/catherinewalsh/Documents/Code/RDoC_for_GitHub/data/ISC/sISC_pairwise_high_correct_fusiform.npy')
low_correct_spatial_fusiform = numpy.load('/Users/catherinewalsh/Documents/Code/RDoC_for_GitHub/data/ISC/sISC_pairwise_low_correct_fusiform.npy')


```

```{r load in correlation data, include=FALSE}

high_correct_ISC_pairwise <- py$high_correct_pairwise
low_correct_ISC_pairwise <- py$low_correct_pairwise

high_correct_sISC_DFR <- py$high_correct_spatial_DFR
low_correct_sISC_DFR <- py$low_correct_spatial_DFR

high_correct_sISC_fusiform <- py$high_correct_spatial_fusiform
low_correct_sISC_fusiform <- py$low_correct_spatial_fusiform

high_correct_ISC_LOO <- read.csv("data/ISC/ISC_LOO_high_correct.csv", header=FALSE)
low_correct_ISC_LOO <- read.csv("data/ISC/ISC_LOO_low_correct.csv", header=FALSE)

high_correct_sISC_LOO_DFR <- read.csv("data/ISC/sISC_LOO_high_correct_DFR.csv", header=FALSE)
low_correct_sISC_LOO_DFR <- read.csv("data/ISC/sISC_LOO_low_correct_DFR.csv", header=FALSE)

high_correct_sISC_LOO_fusiform <- read.csv("data/ISC/sISC_LOO_high_correct_fusiform.csv", header=FALSE)
low_correct_sISC_LOO_fusiform <- read.csv("data/ISC/sISC_LOO_low_correct_fusiform.csv", header=FALSE)


labels <- read.csv("data/ISC/reduced_labels.csv", header=FALSE, stringsAsFactors = FALSE)

```

```{r save ISC data for later use, eval=FALSE, include=FALSE}

save(high_correct_ISC_pairwise, low_correct_ISC_pairwise, high_correct_sISC_DFR, high_correct_sISC_fusiform, low_correct_sISC_DFR, low_correct_sISC_fusiform, high_correct_ISC_LOO, low_correct_ISC_LOO, high_correct_sISC_LOO_DFR, high_correct_sISC_LOO_fusiform, low_correct_sISC_LOO_DFR, low_correct_sISC_LOO_fusiform, labels, file="data/ISC_data.RData")

```


# Temporal ISC 

Want to look at which regions show a load effect because we're looking at a lot of the Yeo ROIs. 

```{r determine which regions show load effects}

load_effect_LOO <- fisherz(high_correct_ISC_LOO) - fisherz(low_correct_ISC_LOO)

load_effect_LOO[load_effect_LOO == -Inf] <- NA
load_effect_LOO[load_effect_LOO == Inf] <- NA

LOO_results <- data.frame(t=matrix(nrow=297),p=matrix(nrow=297), sig_05=matrix(nrow=297), sig_corrected=matrix(nrow=297))
# one sample t test against 0 

for (region in seq.int(1,297)){
  temp <- t.test(load_effect_LOO[,region])
  LOO_results$t[region] <- temp$statistic
  LOO_results$p[region] <- temp$p.value
  if (temp$p.value < 0.05){
    LOO_results$sig_05[region] <- TRUE
  } else {
    LOO_results$sig_05[region] <- FALSE
  }
  if (temp$p.value < 0.05/297){
    LOO_results$sig_corrected[region] <- TRUE
  } else {
    LOO_results$sig_corrected[region] <- FALSE
  }
}

print("Regions that show a load effect (corrected for multiple comparisons): ")
labels[LOO_results$sig_corrected,]

```

```{r average regions with LE by network}

sig_LOO <- load_effect_LOO[,LOO_results$sig_corrected]

visual <- sig_LOO[,c(1:7,34:39)]
dorsal_attn <- sig_LOO[,c(8:14,40:49)]
ventral_attn <- sig_LOO[,c(15:17,50:53)]
FPCN <- sig_LOO[,c(18:23,54:59)]
DMN <- sig_LOO[,c(25:33,61:64)]

network_avg_LOO <- data.frame(visual=rowMeans(visual), DAN = rowMeans(dorsal_attn), VAN = rowMeans(ventral_attn), FPCN = rowMeans(FPCN), DMN = rowMeans(DMN))

```

## LOO - all subjects

```{r make plots to compare to behavior}

data_for_plot <- data.frame(network_avg_LOO, PTID = constructs_fMRI$PTID, BPRS = p200_clinical_zscores$BPRS_TOT[p200_clinical_zscores$PTID %in% constructs_fMRI$PTID], L3_acc = p200_data$XDFR_MRI_ACC_L3[p200_data$PTID %in% constructs_fMRI$PTID], omnibus_span = constructs_fMRI$omnibus_span_no_DFR_MRI)

data_for_plot$BPRS[data_for_plot$BPRS > 4] <- NA

plot_list <- list()

for (network in seq.int(1,5)){
  for (measure in seq.int(7,9)){
    plot_list[[colnames(data_for_plot)[network]]][[colnames(data_for_plot)[measure]]] <- ggplot(data=data_for_plot, aes_string(x= colnames(data_for_plot)[measure], y = colnames(data_for_plot)[network]))+
      geom_point()+
      stat_smooth(method="lm")+
      theme_classic()
  }
}

```

DAN/L3 acc, trend with BPRS
DMN with L3 acc

```{r make plots}

plot_list[["visual"]][["omnibus_span"]]+ plot_list[["visual"]][["L3_acc"]] + plot_list[["visual"]][["BPRS"]] +
  plot_layout(ncol=2)+
  plot_annotation("Average temporal ISC in Visual ROIs")

for (measure in seq.int(7,9)){
  print(colnames(data_for_plot)[measure])
  print(cor.test(data_for_plot$visual, data_for_plot[,measure]))
}

plot_list[["FPCN"]][["omnibus_span"]]+ plot_list[["FPCN"]][["L3_acc"]] + plot_list[["FPCN"]][["BPRS"]] +
  plot_layout(ncol=2)+
  plot_annotation("Average temporal ISC in FPCN ROIs")

for (measure in seq.int(7,9)){
  print(colnames(data_for_plot)[measure])
  print(cor.test(data_for_plot$FPCN, data_for_plot[,measure]))
}

plot_list[["DMN"]][["omnibus_span"]]+ plot_list[["DMN"]][["L3_acc"]] + plot_list[["DMN"]][["BPRS"]] +
  plot_layout(ncol=2)+
  plot_annotation("Average temporal ISC in DMN ROIs")

for (measure in seq.int(7,9)){
  print(colnames(data_for_plot)[measure])
  print(cor.test(data_for_plot$DMN, data_for_plot[,measure]))
}

plot_list[["DAN"]][["omnibus_span"]]+ plot_list[["DAN"]][["L3_acc"]] + plot_list[["DAN"]][["BPRS"]] +
  plot_layout(ncol=2)+
  plot_annotation("Average temporal ISC in DAN ROIs")

for (measure in seq.int(7,9)){
  print(colnames(data_for_plot)[measure])
  print(cor.test(data_for_plot$DAN, data_for_plot[,measure]))
}

plot_list[["VAN"]][["omnibus_span"]]+ plot_list[["VAN"]][["L3_acc"]] + plot_list[["VAN"]][["BPRS"]] +
  plot_layout(ncol=2)+
  plot_annotation("Average temporal ISC in VAN ROIs")

for (measure in seq.int(7,9)){
  print(colnames(data_for_plot)[measure])
  print(cor.test(data_for_plot$VAN, data_for_plot[,measure]))
}

```
## Pairwise

Here, we're going to do the background calculations look at all the pairwise comparisons of subjects within each network. 

```{r select out significant pairwise and average into networks}

high_pairwise_sig <- high_correct_ISC_pairwise[,,LOO_results$sig_corrected]
low_pairwise_sig <- low_correct_ISC_pairwise[,,LOO_results$sig_corrected]
load_effect_pairwise <- high_pairwise_sig - low_pairwise_sig

visual_pairwise_L3 <- high_pairwise_sig[,,c(1:7,34:39)]
dorsal_attn_pairwise_L3 <- high_pairwise_sig[,,c(8:14,40:49)]
ventral_attn_pairwise_L3 <- high_pairwise_sig[,,c(15:17,50:53)]
FPCN_pairwise_L3 <- high_pairwise_sig[,,c(18:23,54:59)]
DMN_pairwise_L3 <- high_pairwise_sig[,,c(25:33,61:64)]

network_pairwise_high_load <- list(visual = apply(visual_pairwise_L3, c(1,2), mean), FPCN = apply(FPCN_pairwise_L3, c(1,2), mean), DMN = apply(DMN_pairwise_L3, c(1,2), mean), DAN = apply(dorsal_attn_pairwise_L3, c(1,2), mean), VAN = apply(ventral_attn_pairwise_L3, c(1,2), mean))

visual_pairwise <- load_effect_pairwise[,,c(1:7,34:39)]
dorsal_attn_pairwise <- load_effect_pairwise[,,c(8:14,40:49)]
ventral_attn_pairwise <- load_effect_pairwise[,,c(15:17,50:53)]
FPCN_pairwise <- load_effect_pairwise[,,c(18:23,54:59)]
DMN_pairwise <- load_effect_pairwise[,,c(25:33,61:64)]

network_pairwise <- list(visual = apply(visual_pairwise, c(1,2), mean), FPCN = apply(FPCN_pairwise, c(1,2), mean), 
                         DMN = apply(DMN_pairwise, c(1,2), mean), DAN = apply(dorsal_attn_pairwise, c(1,2), mean), 
                         VAN = apply(ventral_attn_pairwise, c(1,2), mean))


```

```{r reorder by groups}

# reorder based on span 
span_order <- order(constructs_fMRI$omnibus_span_no_DFR_MRI)

network_pairwise_span_ordered_high_load <- list()
network_pairwise_span_ordered <- list()
for (network in seq.int(1,5)){
  network_pairwise_span_ordered_high_load[[network]] <- network_pairwise_high_load[[network]][span_order, span_order]
  network_pairwise_span_ordered[[network]] <- network_pairwise[[network]][span_order, span_order]
}

```

```{r make high load graphs}

network_graphs_high_load <- list()

for (network in seq.int(1,5)){
  data <- data.frame(network_pairwise_span_ordered_high_load[[network]][,])
  rownames(data) <- c(1:170)
  colnames(data) <- c(1:170)
  data %>%
    
    # Data wrangling
    as_tibble() %>%
    rowid_to_column(var="X") %>%
    gather(key="Y", value="Z", -1) %>% 
    
    # Change Y to numeric
    mutate(Y=as.numeric(gsub("V","",Y))) -> mutated_data
  # 
  ggplot(data=mutated_data,aes(X, Y, fill= Z)) +
    geom_tile() +
    scale_y_continuous(breaks = c(0,50,100,150),labels=c(0,50,100,150))+
    geom_hline(yintercept=57,color="black")+
    geom_hline(yintercept=114,color="black")+
    geom_vline(xintercept=57,color="black")+
    geom_vline(xintercept=114,color="black")+
    scale_fill_gradient2()+
    theme(aspect=1)+
    labs(fill="ISC")+
    ggtitle(paste("network:",names(network_pairwise)[network]))-> network_graphs_high_load[[network]]
}


```

```{r make load effect graphs}

network_graphs_load_effect <- list()

for (network in seq.int(1,5)){
  data <- data.frame(network_pairwise_span_ordered[[network]][,])
  rownames(data) <- c(1:170)
  colnames(data) <- c(1:170)
  data %>%
    
    # Data wrangling
    as_tibble() %>%
    rowid_to_column(var="X") %>%
    gather(key="Y", value="Z", -1) %>% 
    
    # Change Y to numeric
    mutate(Y=as.numeric(gsub("V","",Y))) -> mutated_data
  # 
  ggplot(data=mutated_data,aes(X, Y, fill= Z)) +
    geom_tile() +
    scale_y_continuous(breaks = c(0,50,100,150),labels=c(0,50,100,150))+
    geom_hline(yintercept=57,color="black")+
    geom_hline(yintercept=114,color="black")+
    geom_vline(xintercept=57,color="black")+
    geom_vline(xintercept=114,color="black")+
    scale_fill_gradient2()+
    theme(aspect=1)+
    labs(fill="Load Effect")+
    ggtitle(paste("network:",names(network_pairwise)[network]))-> network_graphs_load_effect[[network]]
}


```

### High Load 

#### Visualize pairwise comparisons

Let's visualize the pairwise intersubject correlations for each network. Black lines here represent distinctions between working memory capacity groups. 

```{r plot high load network pairwise matrices}

network_graphs_high_load[[1]] 
network_graphs_high_load[[2]] 
network_graphs_high_load[[3]] 
network_graphs_high_load[[4]] 
network_graphs_high_load[[5]] 

```

```{r compute within and across correlations high load}

t_test_res = data.frame(matrix(nrow=5,ncol=2)) 
colnames(t_test_res) <- c("t value","p value")
cols <- c("low_within","low_across","med_within","med_across","high_within","high_across")

group_means <- data.frame(matrix(nrow=5,ncol=6))
colnames(group_means) <- cols

group_se <- data.frame(matrix(nrow=5,ncol=6))
colnames(group_se) <- cols

avg_over_groups<- list(mean=data.frame(within = matrix(nrow=5,ncol=1),across = matrix(nrow=5,ncol=1)),
                       se=data.frame(within = matrix(nrow=5,ncol=1),across = matrix(nrow=5,ncol=1)))

split_list <- list()
all_ISC_list_high_load <- list()

for (network in seq.int(1:5)){
  
  # define dataframes 
  comps <- data.frame(within = matrix(nrow=170,ncol=1),across = matrix(nrow=170,ncol=1))
  
  split_by_groups <- data.frame(matrix(nrow=56,ncol=6))
  colnames(split_by_groups) <- cols
  
  # loop over all subjects and make comparisons
  for (suj in c(1:56, 58:113, 115:170)){
    if (suj < 57){
      comps$within[suj] <- mean(network_pairwise_span_ordered_high_load[[network]][1:56,suj],na.rm=TRUE)
      comps$across[suj] <- mean(network_pairwise_span_ordered_high_load[[network]][c(58:113,115:170),suj],na.rm=TRUE)
    }else if (suj > 57 & suj < 114){ 
      comps$within[suj] <- mean(network_pairwise_span_ordered_high_load[[network]][58:113,suj],na.rm=TRUE)
      comps$across[suj] <- mean(network_pairwise_span_ordered_high_load[[network]][c(1:56,115:170),suj],na.rm=TRUE)
    }else if (suj > 114){ 
      comps$within[suj] <- mean(network_pairwise_span_ordered_high_load[[network]][115:170,suj],na.rm=TRUE)
      comps$across[suj] <- mean(network_pairwise_span_ordered_high_load[[network]][c(1:56,58:113),suj],na.rm=TRUE)}
    
  }
  all_ISC_list_high_load[[names(network_pairwise)[network]]] <- comps 
  
  # average over groups 
  avg_over_groups[["mean"]]$within[network] <- mean(comps$within, na.rm=TRUE)
  avg_over_groups[["mean"]]$across[network] <- mean(comps$across, na.rm=TRUE)
  avg_over_groups[["se"]]$within[network] <- se(comps$within)
  avg_over_groups[["se"]]$across[network] <- se(comps$across)
  
  avg_over_groups[["mean"]]$difference[network] <- avg_over_groups[["mean"]]$within[network] - avg_over_groups[["mean"]]$across[network]
  avg_over_groups[["se"]]$difference[network] <- se(comps$within - comps$across)
  
  # split by groups 
  split_by_groups$low_across <- comps$across[1:56]
  split_by_groups$low_within <- comps$within[1:56]
  
  split_by_groups$med_across <- comps$across[58:113]
  split_by_groups$med_within <- comps$within[58:113]
  
  split_by_groups$high_across <- comps$across[115:170]
  split_by_groups$high_within <- comps$within[115:170]
  
  split_list[[names(network_pairwise)[network]]] <- split_by_groups
  
  group_means[network,] <- colMeans(split_by_groups)
  for (group in seq.int(1,6)){
    group_se[network,group] <- se(split_by_groups[,group])
  }
  temp2 <- t.test(comps$within,comps$across,paired=TRUE,var.equal = FALSE)
  t_test_res[network,] <- c(temp2$statistic,temp2$p.value)
  
}

rownames(t_test_res) <- names(network_pairwise) 

```

Here, we're looking to see whether there are significant differences within vs across WMC groups. Visual regions, DMN and DAN regions all show differences within vs across groups. 

```{r}
print(t_test_res)
```

```{r make bar graphs high load}

bar_list <- list()
bar_plot_data <- data.frame(matrix(nrow = 30, ncol=7))
colnames(bar_plot_data) <- c("mean", "se", "network_name", "comparison", "WMC", "err_min", "err_max")
comparison_list <- c("within", "across")
WMC_list <- c("low", "med", "high")
row_count=1
#row for mean, se, network, comparison, WMC
for (network in seq.int(1,5)){
  for (WMC in seq.int(1,3)){
    for (comparison in seq.int(1,2)){
      col_to_look <- ((WMC-1)*2+1) + (comparison-1)
      bar_plot_data$mean[row_count] <- mean(split_list[[network]][,col_to_look])  
      bar_plot_data$se[row_count] <- group_se[network,col_to_look]
      bar_plot_data$err_min[row_count] <- bar_plot_data$mean[row_count] - bar_plot_data$se[row_count]
      bar_plot_data$err_max[row_count] <- bar_plot_data$mean[row_count] + bar_plot_data$se[row_count]
      bar_plot_data$network_name[row_count] <- names(network_pairwise)[network]
      bar_plot_data$comparison[row_count] <- comparison_list[comparison] 
      bar_plot_data$WMC[row_count] <- WMC_list[WMC]
      row_count = row_count+1
    }
  }
  
  bar_plot_data$comparison <- as.factor(bar_plot_data$comparison)
  bar_plot_data$WMC <- factor(bar_plot_data$WMC, levels=c("low", "med", "high"))
  
  bar_plot_data %>%
    filter(network_name == names(network_pairwise)[network]) %>%
    ggplot(aes(x=WMC, y= mean, fill=comparison))+
    geom_bar(stat="identity", position="dodge")+
    geom_errorbar(aes(ymin=err_min, ymax=err_max), position=position_dodge(0.9), width=0.2)+
    ylab("Mean ISC")+
    ggtitle(paste0("network:", names(network_pairwise)[network])) -> bar_list[[names(network_pairwise)[network]]]
  
  
}


```

#### Average over subjects

The visual network, DMN and DAN show a significant effect of comparison, but no main effect of WMC. For the visual network and the DAN, across group comparisons show stronger ISC than within group. For the DMN, within group comparisons show stronger ISC than across group. In contrast, the FPCN only shows an effect of WMC group, where high capacity subjects show stronger ISC (regardless of comparison) than either low or medium WMC subjects, but no effect of comparison. 


```{r plot bar graphs high load}

(bar_list[["visual"]] + bar_list[["FPCN"]]) +
  plot_layout(guides="collect")
(bar_list[["DMN"]]+ bar_list[["DAN"]])+
  plot_layout(guides="collect")
bar_list[["VAN"]] 

```

```{r run anovas for high load split WMC within vs across comparison}

anova_split_high_load_data <- list()

for (network in seq.int(1,5)){
  temp <- melt(split_list[[network]])
  temp$variable <- as.character(temp$variable)
  temp$ID <- c(1:56)
  
  for (row in seq.int(1,nrow(temp))){
    split <- strsplit(temp$variable[row], split="_")[[1]]
    temp$WMC[row] <- split[1]
    temp$comp[row] <- split[2]
    
  }
  colnames(temp)[1:2] <- c("unsplit", "ISC")
  temp$WMC <- factor(temp$WMC, levels = c("low","med", "high"))
  temp$comp <- factor(temp$comp, levels = c("within", "across"))
  temp$ID <- as.factor(temp$ID)
  
  anova_split_high_load_data[[names(split_list)[network]]] <- temp
  print(names(split_list)[network])
  res.aov <- aov(ISC ~ WMC*comp + Error(ID/comp), data = anova_split_high_load_data[[network]])
  print(summary(res.aov))
}


FPCN.aov <- aov(ISC ~ WMC, data= anova_split_high_load_data[["FPCN"]])
TukeyHSD(FPCN.aov)



```


#### Compare to behavior

* VAN - both to acc; trend to span within
* DAN - both to acc; trend to span within
* DMN - both to acc; across to span
* FPCN: across to acc;  within to span 
* visual: both to acc

```{r compare ISC with behavior, warning=FALSE, message=FALSE}

for (network in seq.int(1,5)){
  data_to_plot <- data.frame(constructs_fMRI[span_order, c(1,7)], all_ISC_list_high_load[[network]])
  data_to_plot <- merge(data_to_plot, p200_clinical_zscores[,c(1,2,8)], by="PTID")
  data_to_plot <- merge(data_to_plot, p200_data[,c(1,7)], by="PTID")
  data_to_plot$BPRS_TOT[data_to_plot$BPRS_TOT > 4] <- NA
  
  
  print(names(network_pairwise)[network])
  
  print(ggplot(data = data_to_plot)+
          geom_point(aes(x=omnibus_span_no_DFR_MRI,y=within), fill="black")+
          geom_smooth(aes(x=omnibus_span_no_DFR_MRI,y=within), method="lm", color="black")+
          geom_point(aes(x=omnibus_span_no_DFR_MRI,y=across), color="red")+
          geom_smooth(aes(x=omnibus_span_no_DFR_MRI,y=across), method="lm", color="red")+
          ylab("ISC")+
          ggtitle(paste0("network: "), names(network_pairwise)[network]))
  
  print(cor.test(data_to_plot$omnibus_span_no_DFR_MRI, data_to_plot$within))
  print(cor.test(data_to_plot$omnibus_span_no_DFR_MRI, data_to_plot$across))
  
  
  print(ggplot(data = data_to_plot)+
          geom_point(aes(x=BPRS_TOT,y=within), fill="black")+
          geom_smooth(aes(x=BPRS_TOT,y=within), method="lm", color="black")+
          geom_point(aes(x=BPRS_TOT,y=across), color="red")+
          geom_smooth(aes(x=BPRS_TOT,y=across), method="lm", color="red")+
          ylab("ISC")+
          ggtitle(paste0("network: "), names(network_pairwise)[network]))
  
  print(cor.test(data_to_plot$BPRS_TOT, data_to_plot$within))
  print(cor.test(data_to_plot$BPRS_TOT, data_to_plot$across))
  
  print(ggplot(data = data_to_plot)+
          geom_point(aes(x=XDFR_MRI_ACC_L3,y=within), fill="black")+
          geom_smooth(aes(x=XDFR_MRI_ACC_L3,y=within), method="lm", color="black")+
          geom_point(aes(x=XDFR_MRI_ACC_L3,y=across), color="red")+
          geom_smooth(aes(x=XDFR_MRI_ACC_L3,y=across), method="lm", color="red")+
          ylab("ISC")+
          ggtitle(paste0("network: "), names(network_pairwise)[network]))
  
  print(cor.test(data_to_plot$XDFR_MRI_ACC_L3, data_to_plot$within))
  print(cor.test(data_to_plot$XDFR_MRI_ACC_L3, data_to_plot$across))
  
  
}

```

### Load Effects 

#### Visualize pairs 

```{r plot load effect network pairwise matrices}

network_graphs_load_effect[[1]] 
network_graphs_load_effect[[2]] 
network_graphs_load_effect[[3]] 
network_graphs_load_effect[[4]] 
network_graphs_load_effect[[5]] 

```

```{r compute within and across correlations LE}

t_test_res = data.frame(matrix(nrow=5,ncol=2)) 
colnames(t_test_res) <- c("t value","p value")
cols <- c("low_within","low_across","med_within","med_across","high_within","high_across")

group_means <- data.frame(matrix(nrow=5,ncol=6))
colnames(group_means) <- cols

group_se <- data.frame(matrix(nrow=5,ncol=6))
colnames(group_se) <- cols

avg_over_groups<- list(mean=data.frame(within = matrix(nrow=5,ncol=1),across = matrix(nrow=5,ncol=1)),
                       se=data.frame(within = matrix(nrow=5,ncol=1),across = matrix(nrow=5,ncol=1)))

split_list <- list()

all_ISC_list_LE <- list()

for (network in seq.int(1:5)){
  
  # define dataframes 
  comps <- data.frame(within = matrix(nrow=170,ncol=1),across = matrix(nrow=170,ncol=1))
  
  split_by_groups <- data.frame(matrix(nrow=56,ncol=6))
  colnames(split_by_groups) <- cols
  
  # loop over all subjects and make comparisons
  for (suj in c(1:56, 58:113, 115:170)){
    if (suj < 57){
      comps$within[suj] <- mean(network_pairwise_span_ordered[[network]][1:56,suj],na.rm=TRUE)
      comps$across[suj] <- mean(network_pairwise_span_ordered[[network]][c(58:113,115:170),suj],na.rm=TRUE)
    }else if (suj > 57 & suj < 114){ 
      comps$within[suj] <- mean(network_pairwise_span_ordered[[network]][58:113,suj],na.rm=TRUE)
      comps$across[suj] <- mean(network_pairwise_span_ordered[[network]][c(1:56,115:170),suj],na.rm=TRUE)
    }else if (suj > 114){ 
      comps$within[suj] <- mean(network_pairwise_span_ordered[[network]][115:170,suj],na.rm=TRUE)
      comps$across[suj] <- mean(network_pairwise_span_ordered[[network]][c(1:56,58:113),suj],na.rm=TRUE)
    }
  }
  
  all_ISC_list_LE[[names(network_pairwise)[network]]] <- comps 
  
  
  # average over groups 
  avg_over_groups[["mean"]]$within[network] <- mean(comps$within, na.rm=TRUE)
  avg_over_groups[["mean"]]$across[network] <- mean(comps$across, na.rm=TRUE)
  avg_over_groups[["se"]]$within[network] <- se(comps$within)
  avg_over_groups[["se"]]$across[network] <- se(comps$across)
  
  avg_over_groups[["mean"]]$difference[network] <- avg_over_groups[["mean"]]$within[network] - avg_over_groups[["mean"]]$across[network]
  avg_over_groups[["se"]]$difference[network] <- se(comps$within - comps$across)
  
  # split by groups 
  split_by_groups$low_across <- comps$across[1:56]
  split_by_groups$low_within <- comps$within[1:56]
  
  split_by_groups$med_across <- comps$across[58:113]
  split_by_groups$med_within <- comps$within[58:113]
  
  split_by_groups$high_across <- comps$across[115:170]
  split_by_groups$high_within <- comps$within[115:170]
  
  split_list[[names(network_pairwise)[network]]] <- split_by_groups
  
  group_means[network,] <- colMeans(split_by_groups)
  for (group in seq.int(1,6)){
    group_se[network,group] <- se(split_by_groups[,group])
  }
  temp2 <- t.test(comps$within,comps$across,paired=TRUE,var.equal = FALSE)
  t_test_res[network,] <- c(temp2$statistic,temp2$p.value)
  
}

rownames(t_test_res) <- names(network_pairwise) 

```

Looking at the load effects, we only see differences in within vs across WMC groups for the FPCN. 

```{r}
print(t_test_res)
```

#### Compare across groups

```{r make bar graphs LE}

bar_list <- list()
bar_plot_data <- data.frame(matrix(nrow = 30, ncol=7))
colnames(bar_plot_data) <- c("mean", "se", "network_name", "comparison", "WMC", "err_min", "err_max")
comparison_list <- c("within", "across")
WMC_list <- c("low", "med", "high")
row_count=1
#row for mean, se, network, comparison, WMC
for (network in seq.int(1,5)){
  for (WMC in seq.int(1,3)){
    for (comparison in seq.int(1,2)){
      col_to_look <- ((WMC-1)*2+1) + (comparison-1)
      bar_plot_data$mean[row_count] <- mean(split_list[[network]][,col_to_look])  
      bar_plot_data$se[row_count] <- group_se[network,col_to_look]
      bar_plot_data$err_min[row_count] <- bar_plot_data$mean[row_count] - bar_plot_data$se[row_count]
      bar_plot_data$err_max[row_count] <- bar_plot_data$mean[row_count] + bar_plot_data$se[row_count]
      bar_plot_data$network_name[row_count] <- names(network_pairwise)[network]
      bar_plot_data$comparison[row_count] <- comparison_list[comparison] 
      bar_plot_data$WMC[row_count] <- WMC_list[WMC]
      row_count = row_count+1
    }
  }
  
  bar_plot_data$comparison <- as.factor(bar_plot_data$comparison)
  bar_plot_data$WMC <- factor(bar_plot_data$WMC, levels=c("low", "med", "high"))
  
  bar_plot_data %>%
    filter(network_name == names(network_pairwise)[network]) %>%
    ggplot(aes(x=WMC, y= mean, fill=comparison))+
    geom_bar(stat="identity", position="dodge")+
    geom_errorbar(aes(ymin=err_min, ymax=err_max), position=position_dodge(0.9), width=0.2)+
    ylab("Mean ISC")+
    ggtitle(paste0("network:", names(network_pairwise)[network])) -> bar_list[[names(network_pairwise)[network]]]
  
  
}


```

For the load effects, FPCN shows main effects of both WMC and comparison, but does not show an interaction. DAN just shows a main effect of WMC. 

In the FPCN, we see that high capacity subjects show stronger ISCs than medium or low WMC subjects. However, because this is load effects and the values themselves are negative, this suggests that for high WMC subjects, there is less of a difference between high and load load ISC, while in the medium and low WMC subjects, we see stronger ISC in the low load trials. The within subject main effect tells us that there is a more negative load effect in teh across subject condition, suggesting that there tends to be a larger ISC in the low load trials than high load trials when you compare out of WMC group. 

 For the DAN, we see that high WMC subjects show larger ISC load effects than low WMC subjects, suggesting that there is a larger difference in ISC in the high load trials than low load trials, and that ISC is stronger here in the high load trials. 

```{r plot bar graphs LE}

(bar_list[["visual"]] + bar_list[["FPCN"]]) +
  plot_layout(guides="collect")
(bar_list[["DMN"]]+ bar_list[["DAN"]])+
  plot_layout(guides="collect")
bar_list[["VAN"]] 

```

```{r run anovas for LE split WMC within vs across comparison}

anova_split_high_load_data <- list()

for (network in seq.int(1,5)){
  temp <- melt(split_list[[network]])
  temp$variable <- as.character(temp$variable)
  temp$ID <- c(1:56)
  
  for (row in seq.int(1,nrow(temp))){
    split <- strsplit(temp$variable[row], split="_")[[1]]
    temp$WMC[row] <- split[1]
    temp$comp[row] <- split[2]
    
  }
  colnames(temp)[1:2] <- c("unsplit", "ISC")
  temp$WMC <- factor(temp$WMC, levels = c("low","med", "high"))
  temp$comp <- factor(temp$comp, levels = c("within", "across"))
  temp$ID <- as.factor(temp$ID)
  
  anova_split_high_load_data[[names(split_list)[network]]] <- temp
  print(names(split_list)[network])
  res.aov <- aov(ISC ~ WMC*comp + Error(ID/comp), data = anova_split_high_load_data[[network]])
  print(summary(res.aov))
}


FPCN.aov <- aov(ISC ~ WMC, data= anova_split_high_load_data[["FPCN"]])
TukeyHSD(FPCN.aov)

DAN.aov <- aov(ISC ~ WMC, data= anova_split_high_load_data[["DAN"]])
TukeyHSD(DAN.aov)



```

#### Relate to behavior 

* visual with acc within 
* FPCN with span/within 
* DMN with acc within and across
* DAN with span withi; with acc both; both with BPRS if outlier removed
* VAN within with span 

```{r compare ISC with behavior load effect, warning=FALSE, message=FALSE}

for (network in seq.int(1,5)){
  data_to_plot <- data.frame(constructs_fMRI[span_order, c(1,7)], all_ISC_list_LE[[network]])
  data_to_plot <- merge(data_to_plot, p200_clinical_zscores[,c(1,2,8)], by="PTID")
  data_to_plot <- merge(data_to_plot, p200_data[,c(1,7)], by="PTID")
  data_to_plot$BPRS_TOT[data_to_plot$BPRS_TOT > 4] <- NA
  
  print(names(network_pairwise)[network])
  
  print(ggplot(data = data_to_plot)+
          geom_point(aes(x=omnibus_span_no_DFR_MRI,y=within), fill="black")+
          geom_smooth(aes(x=omnibus_span_no_DFR_MRI,y=within), method="lm", color="black")+
          geom_point(aes(x=omnibus_span_no_DFR_MRI,y=across), color="red")+
          geom_smooth(aes(x=omnibus_span_no_DFR_MRI,y=across), method="lm", color="red")+
          ylab("ISC")+
          ggtitle(paste0("network: "), names(network_pairwise)[network]))
  
  print(cor.test(data_to_plot$omnibus_span_no_DFR_MRI, data_to_plot$within))
  print(cor.test(data_to_plot$omnibus_span_no_DFR_MRI, data_to_plot$across))
  
  
  print(ggplot(data = data_to_plot)+
          geom_point(aes(x=BPRS_TOT,y=within), fill="black")+
          geom_smooth(aes(x=BPRS_TOT,y=within), method="lm", color="black")+
          geom_point(aes(x=BPRS_TOT,y=across), color="red")+
          geom_smooth(aes(x=BPRS_TOT,y=across), method="lm", color="red")+
          ylab("ISC")+
          ggtitle(paste0("network: "), names(network_pairwise)[network]))
  
  print(cor.test(data_to_plot$BPRS_TOT, data_to_plot$within))
  print(cor.test(data_to_plot$BPRS_TOT, data_to_plot$across))
  
  print(ggplot(data = data_to_plot)+
          geom_point(aes(x=XDFR_MRI_ACC_L3,y=within), fill="black")+
          geom_smooth(aes(x=XDFR_MRI_ACC_L3,y=within), method="lm", color="black")+
          geom_point(aes(x=XDFR_MRI_ACC_L3,y=across), color="red")+
          geom_smooth(aes(x=XDFR_MRI_ACC_L3,y=across), method="lm", color="red")+
          ylab("ISC")+
          ggtitle(paste0("network: "), names(network_pairwise)[network]))
  
  print(cor.test(data_to_plot$XDFR_MRI_ACC_L3, data_to_plot$within))
  print(cor.test(data_to_plot$XDFR_MRI_ACC_L3, data_to_plot$across))
  
  
}

```

# Spatial ISC 

This analysis looks at the inter-subject correlation in two different ROIs: a bilateral fusiform ROI from the AAL atlas, and a mask of all regions that showed high load > low load activation during the delay period of the DFR task. 

In order to get this data, we extracted the model-free BOLD activity and applied minimal pre-processing using SPM8 (removing cosine, filtering, detrend and meaning the value across voxels). From there, we separated the data into trials. Because the data was jittered, decided that the onset of a trial should be considered the TR that contains the onset of the trial. Once we had the individual trials separated, we averaged over high and low load trials separately. Correlations were taken across all common voxels in the given mask for each pair of subjects for the high load trials, which is the data that we are showing below. 

```{r load sISC data}

corr_temp <- read.mat("data/ISC_corr.mat")
suj_corr_fusiform <- corr_temp[["suj_corr"]]
corr_temp <- read.mat("data/ISC_corr_DFR_delay.mat")
suj_corr_DFR <- corr_temp[["suj_corr"]]

suj_corr_fusiform[is.nan(suj_corr_fusiform)] <- NA
suj_corr_DFR[is.nan(suj_corr_DFR)] <- NA

source("helper_fxns/avg_ISC.R")
source("helper_fxns/corr_ISC.R")

```

```{r re-order subjects by span sISC}

span_order <- order(constructs_fMRI$omnibus_span_no_DFR_MRI)

fusiform_ISC_ordered <- suj_corr_fusiform[span_order,span_order,]
DFR_ISC_ordered <- suj_corr_DFR[span_order,span_order,]

# select out only subjects who were included in group analyses 

fusiform_ISC_ordered_group <- fusiform_ISC_ordered[c(1:56,58:113,115:170),c(1:56,58:113,115:170),]
DFR_ISC_ordered_group <- DFR_ISC_ordered[c(1:56,58:113,115:170),c(1:56,58:113,115:170),]

# remove NaNs
fusiform_ISC_ordered_group[is.nan(fusiform_ISC_ordered_group)] <- NA
DFR_ISC_ordered_group[is.nan(DFR_ISC_ordered_group)] <- NA



```

```{r create average sISC}

avg_ISC_fusiform <- avg_ISC(suj_corr_fusiform)
avg_ISC_DFR <- avg_ISC(suj_corr_DFR)

overall_avg_ISC_fusiform <- rowMeans(avg_ISC_fusiform)
overall_avg_ISC_DFR <- rowMeans(avg_ISC_DFR)

```

## Fusiform 

First looking at the fusiform mask allows us to get a sense as to what the visual cortex is doing. Seeing results here might reflect perceptual representation of the stimuli, and if we see correlations during delay, might suggest that subjects are maintaining the percept of the faces in a similar way. 

```{r make correlation matrices - fusiform sISC}

graph_fusiform <- list()

for (TR in seq.int(1,14)){
  data <- data.frame(fusiform_ISC_ordered_group[,,TR])
  rownames(data) <- c(1:168)
  colnames(data) <- c(1:168)
  data %>%
    
    # Data wrangling
    as_tibble() %>%
    rowid_to_column(var="X") %>%
    gather(key="Y", value="Z", -1) %>% 
    
    # Change Y to numeric
    mutate(Y=as.numeric(gsub("V","",Y))) -> mutated_data
  # 
  ggplot(data=mutated_data,aes(X, Y, fill= Z)) +
    geom_tile() +
    scale_y_continuous(breaks = c(0,50,100,150),labels=c(0,50,100,150))+
    geom_hline(yintercept=56,color="black")+
    geom_hline(yintercept=113,color="black")+
    geom_vline(xintercept=56,color="black")+
    geom_vline(xintercept=113,color="black")+
    scale_fill_gradient2()+
    theme(aspect=1)+
    ggtitle(paste("TR:",TR))-> graph_fusiform[[TR]]
  
  if (TR > 1){
    graph_fusiform[[TR]][["theme"]][["legend.position"]] = "none"
  }
  
}

```

First, we want to just look at the correlations between subjects over time. We can see that peak intersubject correlations happen around TR 4-6, drop and then get higher around TR 8-9. These TRs correspond to the encoding period and the beginning of the probe period - when there are actually stimuli on the screen. 

The lines here represent divisions between groups - subjects are sorted by span, starting with low span at the bottom left corner and moving up and to the right. There doesn't really seem to be any pattern within or across groups. 

```{r plot fusiform mask sISC}

(graph_fusiform[[1]]+graph_fusiform[[2]] + graph_fusiform[[3]]) +
  plot_layout(guides = "collect")+
  plot_annotation(title="Fusiform Mask")
(graph_fusiform[[4]] + graph_fusiform[[5]] + graph_fusiform[[6]])

(graph_fusiform[[7]] + graph_fusiform[[8]] + graph_fusiform[[9]])

(graph_fusiform[[10]] + graph_fusiform[[11]] + graph_fusiform[[12]])

(graph_fusiform[[13]] + graph_fusiform[[14]])

```

```{r create data we need - fusiform sISC}

z_trans_fusiform <-  atanh(fusiform_ISC_ordered_group)
z_trans_fusiform[z_trans_fusiform==Inf] <- NA
z_trans_corr <- z_trans_fusiform

t_test_res_fusiform = data.frame(matrix(nrow=14,ncol=2)) 
colnames(t_test_res_fusiform) <- c("t value","p value")
cols <- c("low_within","low_across","med_within","med_across","high_within","high_across")

group_means_fusiform <- data.frame(matrix(nrow=14,ncol=6))
colnames(group_means_fusiform) <- cols

group_se_fusiform <- data.frame(matrix(nrow=14,ncol=6))
colnames(group_se_fusiform) <- cols

avg_over_groups_fusiform <- list(mean=data.frame(within = matrix(nrow=14,ncol=1),across = matrix(nrow=14,ncol=1)),
                                 se=data.frame(within = matrix(nrow=14,ncol=1),across = matrix(nrow=14,ncol=1)))

for (TR in seq.int(1:14)){
  
  # define dataframes 
  comps <- data.frame(within = matrix(nrow=168,ncol=1),across = matrix(nrow=168,ncol=1))
  
  
  
  split_by_groups <- data.frame(matrix(nrow=56,ncol=6))
  colnames(split_by_groups) <- cols
  
  # loop over all subjects and make comparisons
  for (suj in seq.int(1,168)){
    if (suj < 57){
      comps$within[suj] <- mean(z_trans_corr[1:56,suj,TR],na.rm=TRUE)
      comps$across[suj] <- mean(z_trans_corr[57:168,suj,TR],na.rm=TRUE)
    }else if (suj > 56 & suj < 113){ 
      comps$within[suj] <- mean(z_trans_corr[57:112,suj,TR],na.rm=TRUE)
      comps$across[suj] <- mean(z_trans_corr[c(1:56,113:168),suj,TR],na.rm=TRUE)
    }else if (suj > 112){ 
      comps$within[suj] <- mean(z_trans_corr[113:168,suj,TR],na.rm=TRUE)
      comps$across[suj] <- mean(z_trans_corr[1:112,suj,TR],na.rm=TRUE)}
    
  }
  
  # average over groups 
  avg_over_groups_fusiform[["mean"]]$within[TR] <- mean(comps$within)
  avg_over_groups_fusiform[["mean"]]$across[TR] <- mean(comps$across)
  avg_over_groups_fusiform[["se"]]$within[TR] <- se(comps$within)
  avg_over_groups_fusiform[["se"]]$across[TR] <- se(comps$across)
  
  avg_over_groups_fusiform[["mean"]]$difference[TR] <- avg_over_groups_fusiform[["mean"]]$within[TR] - avg_over_groups_fusiform[["mean"]]$across[TR]
  avg_over_groups_fusiform[["se"]]$difference[TR] <- se(comps$within - comps$across)
  
  # split by groups 
  split_by_groups$low_across <- comps$across[1:56]
  split_by_groups$low_within <- comps$within[1:56]
  
  split_by_groups$med_across <- comps$across[57:112]
  split_by_groups$med_within <- comps$within[57:112]
  
  split_by_groups$high_across <- comps$across[113:168]
  split_by_groups$high_within <- comps$within[113:168]
  
  group_means_fusiform[TR,] <- colMeans(split_by_groups)
  for (group in seq.int(1,6)){
    group_se_fusiform[TR,group] <- se(split_by_groups[,group])
  }
  temp2 <- t.test(comps$within,comps$across,paired=TRUE,var.equal = FALSE)
  t_test_res_fusiform[TR,] <- c(temp2$statistic,temp2$p.value)
  
}


``` 

```{r run t tests - fusiform sISC,include=FALSE} 

for (TR in seq.int(1,14)){
  
  temp_hist <- melt(comps)
  
  print(ggplot(data=temp_hist)+
          geom_histogram(aes(x=value,fill=variable))+
          ggtitle(paste(TR)))
}

```

All time points are significantly different. 

```{r t test results - fusiform sISC}

print(t_test_res_fusiform)

```


Next, we want to take a quick sanity check and see how just averaging across all subjects, but looking within and across groups. We see similar time courses to what we were seeing with the full matrices. It is interesting to note that within subject correlations are higher than across subject ones. 

```{r plot group x time - fusiform sISC}

plot_temp <- melt(cbind(avg_over_groups_fusiform[["mean"]],time=c(1:14)),id.vars="time")[1:28,]
se_plot_temp <- melt(cbind(avg_over_groups_fusiform[["se"]],time=c(1:14)),id.vars="time")[1:28,]
plot_temp <- merge(plot_temp,se_plot_temp,by=c("time","variable"))
colnames(plot_temp) <- c("time","variable","mean","se")

ggplot(data=plot_temp)+
  geom_line(aes(x=time,y=mean,color=variable))+
  geom_ribbon(aes(x=time,ymin=mean-se,ymax=mean+se,fill=variable),alpha=0.2)+
  ggtitle("Fusiform ISC - regardless of WM group")+
  theme_classic()

```

The last analysis didn't take into account the span of the subjects - now we'll look at them. 

Seems as though low capacity subjects show less within group correlation than the other two groups during encoding, but no real differences otherwise. 

```{r look at correlations across group - fusiform sISC}

group_means_fusiform$TR <- c(1:14) 
group_se_fusiform$TR <- c(1:14) 

melted_group <-  melt(group_means_fusiform, id.vars="TR",value.name="mean")
melted_se <- melt(group_se_fusiform,id.vars="TR",value.name="se")

merge(melted_group,melted_se) %>% 
  ggplot()+
  geom_rect(data=rects,aes(xmin=xstart, xmax=xend, ymin = -Inf, ymax=Inf), fill="grey", alpha =0.4,show.legend = FALSE)+
  geom_line(aes(x=TR,y=mean,color=variable))+
  geom_ribbon(aes(x=TR,ymin=mean-se,ymax=mean+se,fill=variable),alpha=0.2)+
  scale_x_continuous(breaks = c(1:14),labels=c(1:14))+
  ggtitle("Fusiform ISC")+
  theme_classic()-> graph

graph

```

If we average over time, there is a super strong correlation between accuracy and average ISC in the fusiform, but we don't see that for any other relationship.  

```{r correlate fusiform sISC to other measures}

data_to_plot <- merge(constructs_fMRI,p200_clinical_zscores, by="PTID")
data_to_plot <- merge(data_to_plot,p200_data[,c(1,7)])

data_to_plot <- cbind(data_to_plot,overall_avg_ISC_fusiform,overall_avg_ISC_DFR)

cor.test(overall_avg_ISC_fusiform,data_to_plot$omnibus_span_no_DFR_MRI)
cor.test(overall_avg_ISC_fusiform,data_to_plot$XDFR_MRI_ACC_L3)
cor.test(overall_avg_ISC_fusiform,data_to_plot$WHO_ST_S32)
cor.test(overall_avg_ISC_fusiform,data_to_plot$BPRS_TOT)

ggplot(data=data_to_plot,aes(x=overall_avg_ISC_fusiform,omnibus_span_no_DFR_MRI))+
  geom_point()+
  stat_smooth(method="lm")+
  ggtitle("Avg ISC fusiform vs omnibus span")

ggplot(data=data_to_plot,aes(x=overall_avg_ISC_fusiform,XDFR_MRI_ACC_L3))+
  geom_point()+
  stat_smooth(method="lm")+
  ggtitle("Avg ISC fusiform vs L3 DFR Acc")

ggplot(data=data_to_plot,aes(x=overall_avg_ISC_fusiform,WHO_ST_S32))+
  geom_point()+
  stat_smooth(method="lm")+
  ggtitle("Avg ISC fusiform vs WHODAS")

ggplot(data=data_to_plot,aes(x=overall_avg_ISC_fusiform,BPRS_TOT))+
  geom_point()+
  stat_smooth(method="lm")+
  ggtitle("Avg ISC fusiform vs BPRS Total")


```

If we break this down by TR, we see signficant linear relationships between ISC and span at TRs 10 and 11, with WHODAS at TR 10 (but I'm not sure I trust this one...) and accuracy at TRs 1, 2, 4, 5, 6, 7, 10, 11, 12, and 13. 

Overall, it seems that ISC during probe (and a little bit during encoding) is relate to performance and span. 

```{r correlate fusiform sISC to other measures for each time point}

corr_ISC(avg_ISC_fusiform,data_to_plot[,c(1,7)])
corr_ISC(avg_ISC_fusiform,data_to_plot[,c(1,8)])
corr_ISC(avg_ISC_fusiform,data_to_plot[,c(1,14)])
corr_ISC(avg_ISC_fusiform,data_to_plot[,c(1,20)])


```

## DFR

The next step is to look at regions that are actually implicated in working memory. 

```{r make correlation matrices - DFR sISC}

graph_DFR <- list()

for (TR in seq.int(1,14)){
  data <- data.frame(DFR_ISC_ordered_group[,,TR])
  rownames(data) <- c(1:168)
  colnames(data) <- c(1:168)
  data %>%
    
    # Data wrangling
    as_tibble() %>%
    rowid_to_column(var="X") %>%
    gather(key="Y", value="Z", -1) %>% 
    
    # Change Y to numeric
    mutate(Y=as.numeric(gsub("V","",Y))) -> mutated_data
  # 
  ggplot(data=mutated_data,aes(X, Y, fill= Z)) +
    geom_tile() +
    scale_y_continuous(breaks = c(0,50,100,150),labels=c(0,50,100,150))+
    geom_hline(yintercept=56,color="black")+
    geom_hline(yintercept=113,color="black")+
    geom_vline(xintercept=56,color="black")+
    geom_vline(xintercept=113,color="black")+
    scale_fill_gradient2()+
    theme(aspect=1)+
    ggtitle(paste("TR:",TR))-> graph_DFR[[TR]]
  
  if (TR > 1){
    graph_DFR[[TR]][["theme"]][["legend.position"]] = "none"
  }
  
}

```

These correlations are not as strong as the fusiform mask, but we still do see an increase in correlations around TRs 5-6 (during encoding)

```{r plot DFR mask sISC}

(graph_DFR[[1]]+graph_DFR[[2]] + graph_DFR[[3]]) +
  plot_layout(guides = "collect")+
  plot_annotation(title="DFR Mask")
(graph_DFR[[4]] + graph_DFR[[5]] + graph_DFR[[6]])

(graph_DFR[[7]] + graph_DFR[[8]] + graph_DFR[[9]])

(graph_DFR[[10]] + graph_DFR[[11]] + graph_DFR[[12]])

(graph_DFR[[13]] + graph_DFR[[14]])

```

```{r create data we need - DFR sISC}

z_trans_DFR <-  atanh(DFR_ISC_ordered_group)
z_trans_DFR[z_trans_DFR==Inf] <- NA
z_trans_corr <- z_trans_DFR

t_test_res_DFR = data.frame(matrix(nrow=14,ncol=2)) 
colnames(t_test_res_DFR) <- c("t value","p value")

group_means_DFR <- data.frame(matrix(nrow=14,ncol=6))
colnames(group_means_DFR) <- cols

group_se_DFR <- data.frame(matrix(nrow=14,ncol=6))
colnames(group_se_DFR) <- cols

avg_over_groups_DFR <- list(mean=data.frame(within = matrix(nrow=14,ncol=1),across = matrix(nrow=14,ncol=1)),
                            se=data.frame(within = matrix(nrow=14,ncol=1),across = matrix(nrow=14,ncol=1)))

for (TR in seq.int(1:14)){
  
  # define dataframes 
  comps <- data.frame(within = matrix(nrow=168,ncol=1),across = matrix(nrow=168,ncol=1))
  
  split_by_groups <- data.frame(matrix(nrow=56,ncol=6))
  colnames(split_by_groups) <- cols
  
  # loop over all subjects and make comparisons
  for (suj in seq.int(1,168)){
    if (suj < 57){
      comps$within[suj] <- mean(z_trans_corr[1:56,suj,TR],na.rm=TRUE)
      comps$across[suj] <- mean(z_trans_corr[57:168,suj,TR],na.rm=TRUE)
    }else if (suj > 56 & suj < 113){ 
      comps$within[suj] <- mean(z_trans_corr[57:112,suj,TR],na.rm=TRUE)
      comps$across[suj] <- mean(z_trans_corr[c(1:56,113:168),suj,TR],na.rm=TRUE)
    }else if (suj > 112){ 
      comps$within[suj] <- mean(z_trans_corr[113:168,suj,TR],na.rm=TRUE)
      comps$across[suj] <- mean(z_trans_corr[1:112,suj,TR],na.rm=TRUE)}
    
  }
  
  # average over groups 
  avg_over_groups_DFR[["mean"]]$within[TR] <- mean(comps$within)
  avg_over_groups_DFR[["mean"]]$across[TR] <- mean(comps$across)
  avg_over_groups_DFR[["se"]]$within[TR] <- se(comps$within)
  avg_over_groups_DFR[["se"]]$across[TR] <- se(comps$across)
  
  avg_over_groups_DFR[["mean"]]$difference[TR] <- avg_over_groups_DFR[["mean"]]$within[TR] - avg_over_groups_DFR[["mean"]]$across[TR]
  avg_over_groups_DFR[["se"]]$difference[TR] <- se(comps$within - comps$across)
  
  # split by groups 
  split_by_groups$low_across <- comps$across[1:56]
  split_by_groups$low_within <- comps$within[1:56]
  
  split_by_groups$med_across <- comps$across[57:112]
  split_by_groups$med_within <- comps$within[57:112]
  
  split_by_groups$high_across <- comps$across[113:168]
  split_by_groups$high_within <- comps$within[113:168]
  
  group_means_DFR[TR,] <- colMeans(split_by_groups)
  for (group in seq.int(1,6)){
    group_se_DFR[TR,group] <- se(split_by_groups[,group])
  }
  
  temp2 <- t.test(comps$within,comps$across,paired=TRUE,var.equal = FALSE)
  t_test_res_DFR[TR,] <- c(temp2$statistic,temp2$p.value)
  
}


``` 

```{r run t tests - DFR,include=FALSE} 

for (TR in seq.int(1,14)){
  
  temp_hist <- melt(comps)
  
  print(ggplot(data=temp_hist)+
          geom_histogram(aes(x=value,fill=variable))+
          ggtitle(paste(TR)))
}

```

All time points are significantly different. 

```{r t test results - DFR sISC}

print(t_test_res_DFR)

```

Reflecting that, we're seeing lower correlations, but a similar effect that within group correlations are higher than across group. However, we're not seeing as much of a bump in the probe period, and the peak in the encoding is slightly later than in the fusiform region. 

```{r plot group x time - DFR sISC}

plot_temp <- melt(cbind(avg_over_groups_DFR[["mean"]],time=c(1:14)),id.vars="time")[1:28,]
se_plot_temp <- melt(cbind(avg_over_groups_DFR[["se"]],time=c(1:14)),id.vars="time")[1:28,]
plot_temp <- merge(plot_temp,se_plot_temp,by=c("time","variable"))
colnames(plot_temp) <- c("time","variable","mean","se")

ggplot(data=plot_temp)+
  geom_line(aes(x=time,y=mean,color=variable))+
  geom_ribbon(aes(x=time,ymin=mean-se,ymax=mean+se,fill=variable),alpha=0.2)+
  ggtitle("DFR ISC - regardless of WM group")

```

At the beginning of the probe period, we're starting to see potential differences across groups - it almost looks as though there is higher within subject correlations in the medium and high capacity subjects vs low capacity subjects during the probe period. Will need to do further stats to see if this is statistically significant. 

```{r look at correlations across group - DFR sISC}

group_means_DFR$TR <- c(1:14) 
group_se_DFR$TR <- c(1:14) 

melted_group <-  melt(group_means_DFR, id.vars="TR",value.name="mean")
melted_se <- melt(group_se_DFR,id.vars="TR",value.name="se")

merge(melted_group,melted_se) %>% 
  ggplot()+
  geom_rect(data=rects,aes(xmin=xstart, xmax=xend, ymin = -Inf, ymax=Inf), fill="grey", alpha =0.4,show.legend = FALSE)+
  geom_line(aes(x=TR,y=mean,color=variable))+
  geom_ribbon(aes(x=TR,ymin=mean-se,ymax=mean+se,fill=variable),alpha=0.2)+
  scale_x_continuous(breaks = c(1:14),labels=c(1:14))+
  ggtitle("DFR ISC")+
  theme_classic() -> graph

graph

```

If we take the same plan of attack as before and look at the correlation between ISC averaged over the whole time course and cognitive/clinical measures, we're seeing the same thing - nothing except a very strong correlation with performance. 

```{r correlate DFR sISC to other measures}

cor.test(overall_avg_ISC_DFR,data_to_plot$omnibus_span_no_DFR_MRI)
cor.test(overall_avg_ISC_DFR,data_to_plot$XDFR_MRI_ACC_L3)
cor.test(overall_avg_ISC_DFR,data_to_plot$WHO_ST_S32)
cor.test(overall_avg_ISC_DFR,data_to_plot$BPRS_TOT)

ggplot(data=data_to_plot,aes(x=overall_avg_ISC_DFR,omnibus_span_no_DFR_MRI))+
  geom_point()+
  stat_smooth(method="lm")+
  ggtitle("Avg ISC DFR vs omnibus span")

ggplot(data=data_to_plot,aes(x=overall_avg_ISC_DFR,XDFR_MRI_ACC_L3))+
  geom_point()+
  stat_smooth(method="lm")+
  ggtitle("Avg ISC DFR vs L3 DFR Acc")

ggplot(data=data_to_plot,aes(x=overall_avg_ISC_DFR,WHO_ST_S32))+
  geom_point()+
  stat_smooth(method="lm")+
  ggtitle("Avg ISC DFR vs WHODAS")

ggplot(data=data_to_plot,aes(x=overall_avg_ISC_DFR,BPRS_TOT))+
  geom_point()+
  stat_smooth(method="lm")+
  ggtitle("Avg ISC DFR vs BPRS Total")


```

If we break it down by TR, we again see correlations between ISC in the DFR regions and omnibus span at TR 10 and 11, WHODAS at TR 10 (but same concerns as above), and accuracy at TRs 1, 2, 4, 5, 6, 7, 10, 11, 12, and 13.   

```{r compare DFR sISC to measures}

corr_ISC(avg_ISC_DFR,data_to_plot[,c(1,7)])
corr_ISC(avg_ISC_DFR,data_to_plot[,c(1,8)])
corr_ISC(avg_ISC_DFR,data_to_plot[,c(1,14)])
corr_ISC(avg_ISC_DFR,data_to_plot[,c(1,20)])

```