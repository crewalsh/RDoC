---
title: "Beta Series Connectivity"
author: "Catherine Walsh"
date: "11/7/2020"
output:
  html_document:
    toc: true 
    toc_float: true 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This analysis looks at the beta series connectivity between the fronto-parietal control and default mode networks from the Yeo atlas, in addition to individually defined ROIs from the FFA and the anterior, medial and posterior HPC. Individual connectivity matrices are calculated for each task period (encoding, delay and probe).  

```{r load libraries and data}

library(tidyverse)
library(psych)
library(rmatio)
library(patchwork)
library(reshape2)

load('data/behav.RData')
load('data/split_groups_info.RData')

source("helper_fxns/calc_network_avg.R")
source("helper_fxns/mutate_for_heatmap.R")
source("helper_fxns/calc_network_avg_matrix.R")

se <- function(x) {
  sd(x,na.rm=TRUE)/sqrt(length(x[!is.na(x)])) 
}

```

# Prep data

```{r load beta series}

avg_beta_series <- list(cue_load1 = read.mat("data/BetaSeries/RcorrCue_load1_Acc1.mat")$R, 
                        cue_load3 = read.mat("data/BetaSeries/RcorrCue_load3_Acc1.mat")$R,
                        delay_load1 = read.mat("data/BetaSeries/RcorrDelay_load1_Acc1.mat")$R, 
                        delay_load3 = read.mat("data/BetaSeries/RcorrDelay_load3_Acc1.mat")$R, 
                        probe_load1 = read.mat("data/BetaSeries/RcorrProbe_load1_Acc1.mat")$R, 
                        probe_load3 = read.mat("data/BetaSeries/RcorrProbe_load3_Acc1.mat")$R)

rois <- read.mat("data/BetaSeries/roi_order.mat")$roi
beta_series_sujs <- unlist(read.mat("data/BetaSeries/suj_order.mat"))
beta_series_cond_order <- read.mat("data/BetaSeries/condition_order.mat")

suj_by_cond <- read.mat("data/BetaSeries/Suj_by_Cond.mat")$Suj_by_Cond


```

```{r calculate arctanh}

for (cond in seq.int(1,6)){ 
  avg_beta_series[[cond]] <- atanh(avg_beta_series[[cond]])
}

for (suj in seq.int(1,168)){
  for (cond in seq.int(7,12)){
    suj_by_cond[[suj]][[cond]] <- atanh(suj_by_cond[[suj]][[cond]]) 
    
  }
}

```

For most of these analyses, we are going to just look at the average connectivity across networks. In addition, however, we're going to break the FPCN into more parietal regions and more PFC regions, and segment the hippocampus into anterior, medial and posterior segments. 

```{r calculate network avgs}

avg_data <- data.frame(matrix(nrow=6, ncol=34))
colnames(avg_data) <- c("PTID","FPCN_FPCN", "DMN_DMN", "HPC_HPC", "FFA_FFA", "FPCN_DMN", "FPCN_HPC", "FPCN_FFA", "DMN_HPC",
                        "DMN_FFA", "HPC_FFA", "FPCN_PFC_FPCN_PFC", "FPCN_PFC_FPCN_Par", "FPCN_PFC_DMN", "FPCN_PFC_HPC", 
                        "FPCN_PFC_FFA", "FPCN_Par_DMN", "FPCN_Par_HPC", "FPCN_Par_FFA", "FPCN_HPC_Ant", "FPCN_PFC_HPC_Ant",
                        "FPCN_Par_HPC_Ant", "DMN_HPC_Ant", "FFA_HPC_Ant","FPCN_HPC_Med", "FPCN_PFC_HPC_Med",
                        "FPCN_Par_HPC_Med", "DMN_HPC_Med", "FFA_HPC_Med","FPCN_HPC_Post", "FPCN_PFC_HPC_Post",
                        "FPCN_Par_HPC_Post", "DMN_HPC_Post", "FFA_HPC_Post")

for (cond in seq.int(1,6)){ 
  avg_data[cond,] <- calc_network_avg(names(avg_beta_series)[cond],avg_beta_series[[cond]] )
}

suj_avg_data <- data.frame(matrix(nrow=169, ncol=34))
colnames(suj_avg_data) <- c("PTID","FPCN_FPCN", "DMN_DMN", "HPC_HPC", "FFA_FFA", "FPCN_DMN", "FPCN_HPC", "FPCN_FFA", "DMN_HPC",
                            "DMN_FFA", "HPC_FFA", "FPCN_PFC_FPCN_PFC", "FPCN_PFC_FPCN_Par", "FPCN_PFC_DMN", "FPCN_PFC_HPC", 
                            "FPCN_PFC_FFA", "FPCN_Par_DMN", "FPCN_Par_HPC", "FPCN_Par_FFA", "FPCN_HPC_Ant", "FPCN_PFC_HPC_Ant",
                            "FPCN_Par_HPC_Ant", "DMN_HPC_Ant", "FFA_HPC_Ant","FPCN_HPC_Med", "FPCN_PFC_HPC_Med",
                            "FPCN_Par_HPC_Med", "DMN_HPC_Med", "FFA_HPC_Med","FPCN_HPC_Post", "FPCN_PFC_HPC_Post",
                            "FPCN_Par_HPC_Post", "DMN_HPC_Post", "FFA_HPC_Post")

suj_avg_list <- list(
  cue_load3 = suj_avg_data, 
  delay_load3 = suj_avg_data,
  probe_load3 = suj_avg_data,
  cue_load1 = suj_avg_data, 
  delay_load1 = suj_avg_data,
  probe_load1 = suj_avg_data,
  cue_load_effect = suj_avg_data, 
  delay_load_effect = suj_avg_data, 
  probe_load_effect = suj_avg_data
)

for (cond in seq.int(7,12)){
  for (suj in seq.int(1,169)){
    if (suj != 55){
      suj_avg_list[[cond-6]][suj,] <- calc_network_avg(beta_series_sujs[suj], suj_by_cond[[suj]][[cond]])
    }else{ 
      suj_avg_list[[cond-6]]$PTID[suj] <- beta_series_sujs[suj]
    }
  }
  suj_avg_list[[cond-6]]$PTID <- c(suj_avg_list[[cond-6]]$PTID[1:54], 1554, suj_avg_list[[cond-6]]$PTID[55:168])
}

for (LE in seq.int(7,9)){
  suj_avg_list[[LE]]$PTID <- suj_avg_list[[1]]$PTID
}



```

```{r calculate load effects}

suj_avg_list[["cue_load_effect"]][,2:34] <- suj_avg_list[["cue_load3"]][,2:34] - suj_avg_list[["cue_load1"]][,2:34]
suj_avg_list[["delay_load_effect"]][,2:34] <- suj_avg_list[["delay_load3"]][,2:34] - suj_avg_list[["delay_load1"]][,2:34]
suj_avg_list[["probe_load_effect"]][,2:34] <- suj_avg_list[["probe_load3"]][,2:34] - suj_avg_list[["probe_load1"]][,2:34]

avg_data[7,2:34] <- avg_data[2,2:34]- avg_data[1,2:34]
avg_data$PTID[7] <- "cue_load_effect"
avg_data[8,2:34] <- avg_data[4,2:34]- avg_data[3,2:34]
avg_data$PTID[8] <- "delay_load_effect" 
avg_data[9,2:34] <- avg_data[6,2:34]- avg_data[5,2:34]
avg_data$PTID[9] <- "probe_load_effect"

avg_beta_series[["cue_load_effect"]] <- avg_beta_series[["cue_load3"]] - avg_beta_series[["cue_load1"]]
avg_beta_series[["delay_load_effect"]] <- avg_beta_series[["delay_load3"]] - avg_beta_series[["delay_load1"]]
avg_beta_series[["probe_load_effect"]] <- avg_beta_series[["probe_load3"]] - avg_beta_series[["probe_load1"]]

```

```{r check change in span group when EEG removed}

check_span_groups <- constructs_fMRI 

check_span_groups<- check_span_groups[order(check_span_groups$omnibus_span_no_DFR_MRI),]
check_span_groups$without_MRI <- "low"
check_span_groups$without_MRI[57] <- "not_incl"
check_span_groups$without_MRI[58:113] <- "med"
check_span_groups$without_MRI[114] <- "not_incl"
check_span_groups$without_MRI[115:170] <- "high"

check_span_groups<- check_span_groups[order(check_span_groups$omnibus_span_no_DFR),]
check_span_groups$without_EEG <- "low"
check_span_groups$without_EEG[57] <- "not_incl"
check_span_groups$without_EEG[58:113] <- "med"
check_span_groups$without_EEG[114] <- "not_incl"
check_span_groups$without_EEG[115:170] <- "high"

#sum(check_span_groups$without_MRI != check_span_groups$without_EEG, na.rm=TRUE)
check_span_groups <- merge(check_span_groups, p200_demographics)
colnames(check_span_groups)[10] <- "level"

WM_groups_no_EEG <- list(high = check_span_groups %>% filter(level == "high"),
                         med = check_span_groups %>% filter(level == "med"), 
                         low = check_span_groups %>% filter(level == "low"))

WM_groups_no_EEG[["all"]] <- rbind(WM_groups_no_EEG[["low"]],WM_groups_no_EEG[["med"]],WM_groups_no_EEG[["high"]] )

```

```{r add span info}

WM_merge <- merge(WM_groups_no_EEG[["all"]], constructs_fMRI)

for (cond in seq.int(1,9)){
  suj_avg_list[[cond]] <- merge(suj_avg_list[[cond]], WM_merge, by = "PTID")
}

```

```{r remove outliers}

for (cond in seq.int(4,9)){
  for (col in seq.int(2,34)){
    m <- mean(suj_avg_list[[cond]][,col], na.rm=TRUE)
    s <- sd(suj_avg_list[[cond]][,col], na.rm=TRUE)
    max <- m + 3*s 
    min <- m - 3*s 
    suj_avg_list[[cond]][[is.na(suj_avg_list[[cond]][,col]),col]] <- 999
    suj_avg_list[[cond]][(suj_avg_list[[cond]][,col] < min | suj_avg_list[[cond]][,col] > max), col] <- NA
  }
}

```

# High Load

Here, we are just looking at the connectivity across the task at high load. First, we're going to just plot the connectivity matrices to get a sense of how things look at the network level. 

## Connectivity Matrices

```{r create network averages for high load}
networks <- c("FPCN", "FPCN_PFC", "FPCN_Par","DMN", "HPC", "HPC_Ant","HPC_Med", "HPC_Post", "FFA")
cond_list <- c("Cue", "Delay", "Probe")

for (cond in c(2,4,6)){
  calc_network_avg_matrix(avg_beta_series[[cond]]) %>% 
    as_tibble() %>%
    rowid_to_column("X") %>%
    gather(key="Y", value="Z", -1) %>%
    #mutate(Y=as.numeric(gsub("V","",Y))) %>%
    ggplot()+
    geom_tile(aes(x=X,y=Y, fill=Z))+
    theme_classic()+
    theme(aspect.ratio=1, 
          axis.line=element_blank(),
          axis.ticks = element_blank(), 
          axis.text.x = element_text(angle=45, hjust=1))+
    scale_x_continuous(breaks = c(1:9), labels=networks)+
    scale_fill_gradient(limits = c(-1,0))+
    labs(x="Network 1", y="Network 2", fill = "Connectivity", title = cond_list[cond/2]) -> temp_plot
  print(temp_plot)
  
}


```

## Directly compare across task period

Next, let's directly compare across task period. If we actually compare the values, we're not seeing any difference across time. 

```{r plot averages -- high load}

avg_data %>% 
  select(PTID, FPCN_FPCN, DMN_DMN, HPC_HPC, FFA_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load3", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("Within Network Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_DMN, FPCN_HPC, FPCN_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load3", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("FPCN Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()


avg_data %>% 
  select(PTID, FPCN_DMN, DMN_HPC, DMN_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load3", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("DMN Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()


avg_data %>% 
  select(PTID, FPCN_HPC, DMN_HPC, HPC_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load3", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("HPC Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_HPC_Ant, DMN_HPC_Ant, FFA_HPC_Ant) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load3", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("Anterior HPC Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_HPC_Med, DMN_HPC_Med, FFA_HPC_Med) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load3", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("Medial HPC Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_HPC_Post, DMN_HPC_Post, FFA_HPC_Post) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load3", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("Posterior HPC Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_FFA, DMN_FFA, HPC_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load3", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("FFA Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()



```

```{r compare high load activity across period}

for (roi in seq.int(2,34)){
  
  temp_data <- data.frame(PTID = suj_avg_list[[1]]$PTID,
                          cue = suj_avg_list[["cue_load3"]][,roi], 
                          delay = suj_avg_list[["probe_load3"]][,roi], 
                          probe = suj_avg_list[["probe_load3"]][,roi])
  
  temp_data <- melt(temp_data, id.vars = "PTID")
  colnames(temp_data) <- c("PTID", "task_period", "connectivity")
  print(colnames(suj_avg_list[[1]][roi]))
  print(summary(aov(connectivity ~ task_period + Error(PTID), data = temp_data)))
  
}

```

## Split by groups

If we plot by WM capacity group, we're not seeing any significant differences either. 

```{r plot high load by group, message=FALSE, warning=FALSE}

plot_list_L3 <- list()

for (cond in seq.int(7,9)){
  
  cond_list <- list()
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_FPCN", "DMN_DMN", "HPC_HPC", "FFA_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["within"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_DMN", "FPCN_HPC", "FPCN_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["FPCN"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_DMN", "DMN_HPC","DMN_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["DMN"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_HPC", "DMN_HPC","HPC_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["HPC"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_HPC_Ant", "DMN_HPC_Ant","FFA_HPC_Ant")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["HPC_Ant"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_HPC_Med", "DMN_HPC_Med","FFA_HPC_Med")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["HPC_Med"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_HPC_Post", "DMN_HPC_Post","FFA_HPC_Post")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "Post", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["HPC_Post"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_HPC", "DMN_HPC","HPC_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["HPC"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_FFA", "DMN_FFA","HPC_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["FFA"]]
  plot_list_L3[[names(suj_avg_list)[cond]]] <- cond_list
}

plot_list_L3[["cue_load_effect"]][["within"]] + plot_list_L3[["delay_load_effect"]][["within"]] + plot_list_L3[["probe_load_effect"]][["within"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "Within Network Connectivity")

plot_list_L3[["cue_load_effect"]][["FPCN"]] + plot_list_L3[["delay_load_effect"]][["FPCN"]] + plot_list_L3[["probe_load_effect"]][["FPCN"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "FPCN Connectivity")

plot_list_L3[["cue_load_effect"]][["DMN"]] + plot_list_L3[["delay_load_effect"]][["DMN"]] + 
  plot_list_L3[["probe_load_effect"]][["DMN"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "DMN Connectivity")

plot_list_L3[["cue_load_effect"]][["HPC"]] + plot_list_L3[["delay_load_effect"]][["HPC"]] + 
  plot_list_L3[["probe_load_effect"]][["HPC"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "HPC Connectivity")

plot_list_L3[["cue_load_effect"]][["HPC_Ant"]] + plot_list_L3[["delay_load_effect"]][["HPC_Ant"]] + 
  plot_list_L3[["probe_load_effect"]][["HPC_Ant"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "Anterior HPC Connectivity")

plot_list_L3[["cue_load_effect"]][["HPC_Med"]] + plot_list_L3[["delay_load_effect"]][["HPC_Med"]] + 
  plot_list_L3[["probe_load_effect"]][["HPC_Med"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "Medial HPC Connectivity")

plot_list_L3[["cue_load_effect"]][["HPC_Post"]] + plot_list_L3[["delay_load_effect"]][["HPC_Post"]] + 
  plot_list_L3[["probe_load_effect"]][["HPC_Post"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "Posterior HPC Connectivity")

plot_list_L3[["cue_load_effect"]][["FFA"]] + plot_list_L3[["delay_load_effect"]][["FFA"]] + 
  plot_list_L3[["probe_load_effect"]][["FFA"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "FFA Connectivity")

```

```{r plots for presentation, eval = FALSE, include = FALSE}

suj_avg_list[[1]] %>% 
  melt() %>%
  filter(variable %in% c("HPC_HPC")) %>%
  group_by(level, variable) %>% 
  summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
  mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
  ggplot(aes(x=level, y = average)) + 
  geom_bar(stat="identity", position = "dodge", fill="#536895")+
  geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
  xlab("Regions")+
  ylab("Average Connectivity")+
  theme_classic()+
  ggtitle("Cue Load 3")+
  theme(aspect.ratio=1, text= element_text(size = 24)) -> HPC_cue_load3

HPC_cue_load3

#ggsave("~/Documents/UCLA/Conferences/BAMM/HPC_conn_cue_load3.jpg", HPC_cue_load3)

suj_avg_list[[4]] %>% 
  melt() %>%
  filter(variable %in% c("HPC_HPC")) %>%
  group_by(level, variable) %>% 
  summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
  mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
  ggplot(aes(x=level, y = average)) + 
  geom_bar(stat="identity", position = "dodge", fill="#536895")+
  geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
  xlab("Regions")+
  ylab("Average Connectivity")+
  ggtitle("Cue Load 1")+
  theme_classic()+
  theme(aspect.ratio=1, text= element_text(size = 24)) -> HPC_cue_load1
ggsave("~/Documents/UCLA/Conferences/BAMM/HPC_conn_cue_load1.jpg", HPC_cue_load1)

HPC_cue_load3.aov <- aov(HPC_HPC ~ level, data = suj_avg_list[[1]])
summary(HPC_cue_load3.aov)


HPC_cue_load1.aov <- aov(HPC_HPC ~ level, data = suj_avg_list[[4]])
summary(HPC_cue_load1.aov)
TukeyHSD(HPC_cue_load1.aov)


```


```{r anovas for high load}

for (cond in seq.int(1,3)){
  print(names(suj_avg_list)[cond])
  anova_results <- purrr::map(suj_avg_list[[cond]][,2:34], ~aov(.x ~ suj_avg_list[[cond]]$level ))
  for (measure in seq.int(1,33)){
    print(colnames(suj_avg_list[[cond]])[measure+1])
    print(summary(anova_results[[measure]]))
  }
}

```

# Load Effect

Looking at load effect is more in line with the rest of our fMRI analyses, so let's look at those. Again, we're first going to plot the entire network connectivity matrix, to get a sense of the networks as a whole. 

## Connectivity matrix

```{r create network averages load effect}

for (cond in seq.int(7,9)){
  calc_network_avg_matrix(avg_beta_series[[cond]]) %>% 
    as_tibble() %>%
    rowid_to_column("X") %>%
    gather(key="Y", value="Z", -1) %>%
    ggplot()+
    geom_tile(aes(x=X,y=Y, fill=Z))+
    theme_classic()+
    theme(aspect.ratio=1, 
          axis.line=element_blank(),
          axis.ticks = element_blank(), 
          axis.text.x = element_text(angle=45, hjust=1))+
    scale_x_continuous(breaks = c(1:9), labels=networks)+
    scale_fill_gradient(limits = c(-0.075,0.15))+
    labs(x="Network 1", y="Network 2", fill = "Connectivity", title = cond_list[cond-6]) -> temp_plot
  print(temp_plot)
  
}


```

Overall, we're seeing load effects that are significantly different from zero in the parietal regions of the FPCN with the HPC (particularly the medial region) and the FFA during cue, and the FPCN and FFA with the anterior HPC, and the parietal regions of the FPCN with the anterior regions of the HPC during delay. No regions showed a significant overall load effect in the probe period. 

```{r check if load effects are diff from zero}

for (cond in seq.int(7,9)){
  print(names(suj_avg_list)[cond])
  for (roi in seq.int(2,34)){
    ttest_res <- (t.test(suj_avg_list[[cond]][,roi]))
    if (ttest_res$p.value < 0.05){
      print(colnames(suj_avg_list[[cond]])[roi])
    }
  }
}

```


## Directly compare across task period

As before, we can then directly compare across time periods. We're not seeing anything too interesting here.

```{r plot averages -- load effect}

avg_data %>% 
  select(PTID, FPCN_FPCN, DMN_DMN, HPC_HPC, FFA_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load_effect", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("Within Network Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_DMN, FPCN_HPC, FPCN_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load_effect", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("FPCN Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_PFC_FPCN_Par, FPCN_PFC_DMN, FPCN_PFC_HPC, FPCN_PFC_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load_effect", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("FPCN PFC region connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_PFC_FPCN_Par, FPCN_Par_DMN, FPCN_Par_HPC, FPCN_Par_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load_effect", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("FPCN Parietal region connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()


avg_data %>% 
  select(PTID, FPCN_DMN, DMN_HPC, DMN_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load_effect", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("DMN Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()


avg_data %>% 
  select(PTID, FPCN_HPC, DMN_HPC, HPC_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load_effect", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("HPC Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_HPC_Ant, DMN_HPC_Ant, FFA_HPC_Ant) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load_effect", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("Anterior HPC Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_HPC_Med, DMN_HPC_Med, FFA_HPC_Med) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load_effect", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("Medial HPC Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_HPC_Post, DMN_HPC_Post, FFA_HPC_Post) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load_effect", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("Posterior HPC Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()

avg_data %>% 
  select(PTID, FPCN_FFA, DMN_FFA, HPC_FFA) %>%
  melt(id.vars="PTID") %>% 
  filter(grepl("load_effect", PTID)) %>% 
  ggplot(aes(x=variable, y =value, fill = PTID))+
  geom_bar(stat="identity", position = "dodge")+
  ggtitle("FFA Connectivity")+
  ylab("Connectivity")+
  xlab("Network")+
  theme_classic()


```

```{r compare load effect activity across period}

for (roi in seq.int(2,34)){
  
  temp_data <- data.frame(
    PTID = suj_avg_list[[1]]$PTID,
    cue = suj_avg_list[["cue_load_effect"]][,roi], 
    delay = suj_avg_list[["probe_load_effect"]][,roi], 
    probe = suj_avg_list[["probe_load_effect"]][,roi])
  
  temp_data <- melt(temp_data, id.vars="PTID")
  colnames(temp_data) <- c("PTID", "task_period", "connectivity")
  print(colnames(suj_avg_list[[1]][roi]))
  print(summary(aov(connectivity ~ task_period + Error(PTID), data = temp_data)))
  
}

```

```{r more plots for presentataion, include = FALSE, eval=FALSE}

suj_avg_list[["cue_load_effect"]] %>% 
  melt() %>%
  filter(variable == "HPC_HPC") %>%
  group_by(level, variable) %>% 
  summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
  mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
  ggplot(aes(x=level, y = average)) + 
  geom_bar(stat="identity", position = "dodge", fill = "#536895")+
  geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
  xlab("Working Memory Capacity Group")+
  ylab("Average Connectivity Load Effect")+
  theme_classic()+
  theme(aspect.ratio=1, text = element_text(size=24)) -> cue_HPC_HPC

#ggsave("~/Documents/UCLA/Conferences/BAMM/cue_HPC_HPC_conn.jpg", cue_HPC_HPC)

suj_avg_list[["probe_load_effect"]] %>% 
  melt() %>%
  filter(variable == "FPCN_Par_FFA") %>%
  group_by(level, variable) %>% 
  summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
  mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
  ggplot(aes(x=level, y = average)) + 
  geom_bar(stat="identity", position = "dodge", fill = "#536895")+
  geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
  xlab("Working Memory Capacity Group")+
  ylab("Average Connectivity Load Effect")+
  theme_classic()+
  theme(aspect.ratio=1, text = element_text(size=24)) -> probe_FPCN_Par_FFA

#ggsave("~/Documents/UCLA/Conferences/BAMM/probe_FPCN_Par_FFA_conn.jpg", probe_FPCN_Par_FFA)

suj_avg_list[["probe_load_effect"]] %>% 
  ggplot(aes(x=omnibus_span_no_DFR, y=FPCN_FFA))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_classic()+
  theme(aspect.ratio=1, text = element_text(size=24)) -> FPCN_FFA_scatter
#ggsave("~/Documents/UCLA/Conferences/BAMM/FPCN_FFA_probe_scatter.jpg", FPCN_FFA_scatter)

```

## By WM group

Now, let's look across WM groups (which we care more about anyways). Here, we see differences within HPC in the cue, for the DMN/FFA (low > medium), HPC/FFA (low > medium), parietal regions of the FPCN/DMN (low > medium, with high > medium trending), FFA/anterior HPC regions (low > medium and high) during delay, and parietal regions of the FPCN/FFA (high > low), FFA/posterior HPC (high > low) in probe. 

```{r plot load effects by group, message=FALSE, warning=FALSE}

plot_list_load_effect <- list() 

for (cond in seq.int(7,9)){
  
  cond_list <- list()
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_FPCN", "DMN_DMN", "HPC_HPC", "FFA_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["within"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_DMN", "FPCN_HPC", "FPCN_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["FPCN"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_DMN", "DMN_HPC","DMN_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["DMN"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_HPC", "DMN_HPC","HPC_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["HPC"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_HPC_Ant", "DMN_HPC_Ant","FFA_HPC_Ant")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["HPC_Ant"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_HPC_Med", "DMN_HPC_Med","FFA_HPC_Med")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["HPC_Med"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_HPC_Post", "DMN_HPC_Post","FFA_HPC_Post")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["HPC_Post"]]
  
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_FFA", "DMN_FFA","HPC_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["FFA"]]
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_PFC_FPCN_Par", "FPCN_PFC_DMN", "FPCN_PFC_HPC", "FPCN_PFC_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["FPCN_PFC"]]
  
  
  suj_avg_list[[cond]] %>% 
    melt() %>%
    filter(variable %in% c("FPCN_PFC_FPCN_Par", "FPCN_Par_DMN", "FPCN_Par_HPC", "FPCN_Par_FFA")) %>%
    group_by(level, variable) %>% 
    summarise(average = mean(value, na.rm=TRUE), se_val = se(value), se_min = average-se_val, se_max = average+se_val) %>% 
    mutate(level = factor(level, levels = c("low", "med", "high"))) %>%
    ggplot(aes(x=variable, y = average, fill=level)) + 
    geom_bar(stat="identity", position = "dodge")+
    geom_errorbar(aes(ymin = se_min, ymax = se_max), width=0.1, position = position_dodge(0.9))+
    xlab("Regions")+
    ylab("Average Connectivity")+
    ggtitle(paste(names(suj_avg_list)[cond]))+
    theme_classic()+
    theme(aspect.ratio=1, axis.text.x = element_text(angle = 45, vjust = 0.5)) -> cond_list[["FPCN_Par"]]
  
  plot_list_load_effect[[names(suj_avg_list)[cond]]] <- cond_list
}

plot_list_load_effect[["cue_load_effect"]][["within"]] + plot_list_load_effect[["delay_load_effect"]][["within"]] + plot_list_load_effect[["probe_load_effect"]][["within"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "Within Network Connectivity")

plot_list_load_effect[["cue_load_effect"]][["FPCN"]] + plot_list_load_effect[["delay_load_effect"]][["FPCN"]] + plot_list_load_effect[["probe_load_effect"]][["FPCN"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "FPCN Connectivity")

plot_list_load_effect[["cue_load_effect"]][["FPCN_PFC"]] + plot_list_load_effect[["delay_load_effect"]][["FPCN_PFC"]] + plot_list_load_effect[["probe_load_effect"]][["FPCN_PFC"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "FPCN PFC regions Connectivity")

plot_list_load_effect[["cue_load_effect"]][["FPCN_Par"]] + plot_list_load_effect[["delay_load_effect"]][["FPCN_Par"]]+ plot_list_load_effect[["probe_load_effect"]][["FPCN_Par"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "FPCN parietal regions Connectivity")

plot_list_load_effect[["cue_load_effect"]][["DMN"]] + plot_list_load_effect[["delay_load_effect"]][["DMN"]] + 
  plot_list_load_effect[["probe_load_effect"]][["DMN"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "DMN Connectivity")

plot_list_load_effect[["cue_load_effect"]][["HPC"]] + plot_list_load_effect[["delay_load_effect"]][["HPC"]] + 
  plot_list_load_effect[["probe_load_effect"]][["HPC"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "HPC Connectivity")

plot_list_load_effect[["cue_load_effect"]][["HPC_Ant"]] + plot_list_load_effect[["delay_load_effect"]][["HPC_Ant"]] + 
  plot_list_load_effect[["probe_load_effect"]][["HPC_Ant"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "Anterior HPC Connectivity")

plot_list_load_effect[["cue_load_effect"]][["HPC_Med"]] + plot_list_load_effect[["delay_load_effect"]][["HPC_Med"]] + 
  plot_list_load_effect[["probe_load_effect"]][["HPC_Med"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "Medial HPC Connectivity")

plot_list_load_effect[["cue_load_effect"]][["HPC_Post"]] + plot_list_load_effect[["delay_load_effect"]][["HPC_Post"]] + 
  plot_list_load_effect[["probe_load_effect"]][["HPC_Post"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "Posterior HPC Connectivity")

plot_list_load_effect[["cue_load_effect"]][["FFA"]] + plot_list_load_effect[["delay_load_effect"]][["FFA"]] + 
  plot_list_load_effect[["probe_load_effect"]][["FFA"]] +
  plot_layout(guides="collect")+
  plot_annotation(title = "FFA Connectivity")

```

```{r compute ANOVAs on load effects}

# for (cond in seq.int(7,9)){
#   print(names(suj_avg_list)[cond])
#   anova_results <- purrr::map(suj_avg_list[[cond]][,2:34], ~aov(.x ~ suj_avg_list[[cond]]$level ))
#   for (measure in seq.int(1,33)){
#     print(colnames(suj_avg_list[[cond]])[measure+1])
#     print(summary(anova_results[[measure]]))
#   }
# }

print(TukeyHSD(aov(HPC_HPC ~ level, data = suj_avg_list[["cue_load_effect"]])))
print(TukeyHSD(aov(DMN_FFA ~ level, data = suj_avg_list[["delay_load_effect"]])))
print(TukeyHSD(aov(HPC_FFA ~ level, data = suj_avg_list[["delay_load_effect"]])))
print(TukeyHSD(aov(FPCN_Par_DMN ~ level, data = suj_avg_list[["delay_load_effect"]])))
print(TukeyHSD(aov(FFA_HPC_Ant ~ level, data = suj_avg_list[["delay_load_effect"]])))
print(TukeyHSD(aov(FPCN_Par_FFA ~ level, data = suj_avg_list[["probe_load_effect"]])))
print(TukeyHSD(aov(FFA_HPC_Post ~ level, data = suj_avg_list[["probe_load_effect"]])))

```

## Correlation of load effect with omnibus span

Another way of looking at linear relationships is to look for correlations between connectivity and span. We see significant correlations between span and within FPCN PFC regions and FPCN parietal regions/DMN connectivity at cue, FFA/anterior HPC in delay (which is a negative correlation) and FPCN/FFA (specifically PFC, though trending towards Par), FPCN/Medial HPC, FFA/posterior HPC in probe. 

```{r look for significant correlations between span and connectivity}

# for (cond in seq.int(7,9)){
#   print(names(suj_avg_list)[cond])
#   
#   for (measure in seq.int(2, 34)){
#     print(colnames(suj_avg_list[[cond]])[measure])
#     print(cor.test(suj_avg_list[[cond]][,measure], suj_avg_list[[cond]]$omnibus_span_no_DFR))
#     
#   }
# }

cor.test(suj_avg_list[[7]]$FPCN_PFC_FPCN_PFC, suj_avg_list[[cond]]$omnibus_span_no_DFR)
ggplot(data = suj_avg_list[[7]], aes(x=omnibus_span_no_DFR, y = FPCN_PFC_FPCN_PFC))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_classic()+
  theme(aspect.ratio=1)

cor.test(suj_avg_list[[7]]$FPCN_Par_DMN, suj_avg_list[[cond]]$omnibus_span_no_DFR)
ggplot(data = suj_avg_list[[7]], aes(x=omnibus_span_no_DFR, y = FPCN_Par_DMN))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_classic()+
  theme(aspect.ratio=1)

cor.test(suj_avg_list[[8]]$FFA_HPC_Ant, suj_avg_list[[cond]]$omnibus_span_no_DFR)
ggplot(data = suj_avg_list[[8]], aes(x=omnibus_span_no_DFR, y = FFA_HPC_Ant))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_classic()+
  theme(aspect.ratio=1)

cor.test(suj_avg_list[[9]]$FPCN_FFA, suj_avg_list[[cond]]$omnibus_span_no_DFR)
ggplot(data = suj_avg_list[[9]], aes(x=omnibus_span_no_DFR, y = FPCN_FFA))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_classic()+
  theme(aspect.ratio=1)

cor.test(suj_avg_list[[9]]$FPCN_PFC_FFA, suj_avg_list[[cond]]$omnibus_span_no_DFR)
ggplot(data = suj_avg_list[[9]], aes(x=omnibus_span_no_DFR, y = FPCN_PFC_FFA))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_classic()+
  theme(aspect.ratio=1)

cor.test(suj_avg_list[[9]]$FPCN_Par_FFA, suj_avg_list[[cond]]$omnibus_span_no_DFR)
ggplot(data = suj_avg_list[[9]], aes(x=omnibus_span_no_DFR, y = FPCN_Par_FFA))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_classic()+
  theme(aspect.ratio=1)

cor.test(suj_avg_list[[9]]$FPCN_HPC_Med, suj_avg_list[[cond]]$omnibus_span_no_DFR)
ggplot(data = suj_avg_list[[9]], aes(x=omnibus_span_no_DFR, y = FPCN_HPC_Med))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_classic()+
  theme(aspect.ratio=1)

cor.test(suj_avg_list[[9]]$FFA_HPC_Post, suj_avg_list[[cond]]$omnibus_span_no_DFR)
ggplot(data = suj_avg_list[[9]], aes(x=omnibus_span_no_DFR, y = FFA_HPC_Post))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_classic()+
  theme(aspect.ratio=1)

```

